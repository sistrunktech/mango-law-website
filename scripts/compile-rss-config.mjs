import fs from 'node:fs';
import path from 'node:path';

const projectRoot = path.resolve(new URL('.', import.meta.url).pathname, '..');

function escapeTemplateLiteral(text) {
  return text.replace(/`/g, '\\`').replace(/\$\{/g, '\\${');
}

function writeTsStringModule(outPath, exportName, sourceText) {
  const escaped = escapeTemplateLiteral(sourceText);
  const content = `// This file is generated by scripts/compile-rss-config.mjs\n` +
    `// Do not edit by hand.\n\n` +
    `export const ${exportName} = \`\n${escaped.replace(/\r\n/g, '\n')}\n\`;\n`;
  fs.writeFileSync(outPath, content, 'utf8');
}

const masterCsvPath = path.join(
  projectRoot,
  'supabase',
  'functions',
  'checkpoint-scraper',
  'rss_sources_master.csv'
);
const seedCsvPath = path.join(
  projectRoot,
  'supabase',
  'functions',
  'checkpoint-scraper',
  'checkpoint_rss_sources.csv'
);

const masterOutPath = path.join(
  projectRoot,
  'supabase',
  'functions',
  'checkpoint-scraper',
  'rss-sources-master.csv.ts'
);
const seedOutPath = path.join(
  projectRoot,
  'supabase',
  'functions',
  'checkpoint-scraper',
  'checkpoint-rss-sources.csv.ts'
);

const masterCsv = fs.readFileSync(masterCsvPath, 'utf8');
const seedCsv = fs.readFileSync(seedCsvPath, 'utf8');

writeTsStringModule(masterOutPath, 'RSS_SOURCES_MASTER_CSV', masterCsv);
writeTsStringModule(seedOutPath, 'CHECKPOINT_RSS_SOURCES_CSV', seedCsv);

console.log('Generated:');
console.log(' -', path.relative(projectRoot, masterOutPath));
console.log(' -', path.relative(projectRoot, seedOutPath));

